# PostgreSQL

## 目录
[toc]

## 专题

### 查询postgres版本
```sql
select version();
```

### 插入或更新数据 Upsert
```sql
-- postgres > 9.5 时，可以使用upsert语句：“ON conflict(id) DO”
INSERT INTO test.upsert_test(id, "name")
   VALUES(1, 'm'),(2, 'n'),(4, 'c')
   ON conflict(id) DO UPDATE
   SET "name" = excluded.name;
```

### 删除表如果存在
```sql
DROP TABLE IF EXISTS ...
```



## SQL基础


### 查询 Querying Data

#### 查询 Select 

#### 列别名 Column aliases

#### 排序 Order By

#### 去重 Select Distinct


### 过滤数据 Filtering Data

#### Where - filter rows based on a specified condition

#### Limit - get a subset of rows generated by a query

#### Fetch - limit the number of rows returned by a query

#### In - select data that matches any value in a list of values

#### Between - select data that is a range of values

#### Like - filter data based on pattern matching 

#### Is Null - check if a value is null or not 


### 关联多表 Joining Multiple Tables

#### Joins - show you a brief overview of joins in PostgreSQL

#### Table aliases - describes how to use table aliases in query 

#### Inner Join - select rows from one table that has the corresponding rows in other tables

#### Left Join - select rows from one table that may or may not have the corresponding rows in other tables

#### Self-join - join a table to itself by comparing a table to itself

#### Full Outer Join - use the full join to find a row in a table that does not have a matching row in another table

#### Cross Join - produce a Cartesian product of the rows in two or more tables
#### Natural Join - join two or more tables using implicit join condition based on the common column names in the joined tables


### 分组 Grouping Data

#### Group By - divide rows into groups and applies an aggregate function on each 

#### Having - apply conditions to groups 



### 集合 Set Operations
#### Union - combine result sets of multiple queries into a single result set

#### Intersect - combine the result sets of two or more queries and returns a single result set that has the rows appear in both result sets

#### Except - return the rows in the first query that does not appear in the output of the second query


### Grouping sets, Cube, and Rollup

#### Grouping Sets - generate multiple grouping set in reporting

#### Cube - define multiple grouping sets that include all possible combinations of dimensions

#### Rollup - generate reports that contain totals and subtotals


### 子查询 Subquery

#### Subquery - write a query nested inside another query

#### ANY - retrieve data by comparing a value with a set of values returned by a subquery

#### ALL - query data by comparing a value with a list of values returned by a query

#### EXISTS - check for the existence of rows returned by a subquery




### Common Table Expressions

#### PostgreSQL CTE – introduce you to PostgreSQL common table expressions or CTEs.

#### Recursive query using CTEs – discuss the recursive query and learn how to apply it in various contexts.


### 修改数据 Modifying Data

#### Insert - guide you on how to insert single row into a table

#### Insert multiple rows - show you how to insert multiple rows into a table

#### Update - update existing data in a table 

#### Update join - update value in a table based on values in another table

#### Delete - delete data in a table 

#### Upsert - insert or update data if the new row already exists in the table 




### 事务 Transactions
- PostgreSQL Transactions - show you how to handle transactions in PostgreSQL using BEGIN, COMMIT, and ROLLBACK statements



### 导入导出 Import & Export Data

#### Import CSV file into Table - show you how to import CSV file into a table

#### Export PostgreSQL Table to CSV file - show you how to export table to a CSV file


### 表管理 Managing Tables

#### Data types - cover the most commonly used PostgreSQL data types

#### Create table - guide you on how to create a new table in the database

#### Select Into & Create table as - shows you how to create a new table from the result set of a query

#### Auto-increment column with SERIAL - uses SERIAL to add an auto-increment column to a table

#### Sequences - introduce you to sequences and describe how to use a sequence to generate a sequence of numbers

#### Identity column - show you how to use the identity column

#### Alter table - modify the structure of an existing table

#### Rename table - change the name of the table to a new one

#### Add column - show you how to use add one or more columns to an existing table

#### Drop column - demonstrate how to drop a column of a talbe

#### Change column data type - show you how to change the data of a column

#### Rename column - illustrate how to rename one or more columns of a table

#### Drop table - remove a existing table and all of its dependent objects

#### Truncate table - remove all data in a large table quickly and efficiently

#### Temporary table - show you how to use the temporary table

#### Copy a table - show you how to copy a table to a new one


### 约束 Understanding PostgreSQL Constraints

P

### 数据类型 PostgreSQL Data Types in Depth

### 条件表达式与操作符 Conditional Expressions & Operators

### psql工具 PostgreSQL Utilities

### 技巧 PostgreSQL Recipes

#### 比较两表数据

#### 删除重复行

#### 生成随机数

#### EXPLAIN 表达式

#### PostgreSQL vs. MySQL


## SQL编程 PL/PGSQL

PL/pgSQL procedural language adds many procedural elements e.g., control structures, loops, and complex functions and stored procedures in PostgreSQL the may not be possible using plain SQL.

PL/pgSQL procedural language is similar to the Oracel PL/SQL. The following are reasons to learn PL/pgSQL:
	* PL/pgSQL is easy to learn and simple to use
	* PL/pgSQL comes with PostgreSQL by default. The user-defined functions and stored procedures developed in PL/pgSQL can be used like any built-in functions and stored procedures.
	* PL/pgSQL inherits all user-defined types, functions, and operators.
	* PL/pgSQL has many features that allow you to develop complex functions and stored procedures.
	* PL/pgSQL can be defined to be trusted by the PostgreSQL database server.


### 入门 Getting started

#### Introduction to PostgreSQL PL/pgSQL - introduce you to the PostgreSQL PL/pgSQL and explain to you their advantages and disadvantages

#### Dollar-quoted string constants - learn how to use dollar-quoted string constants syntax.

#### Block Structure - introduce you to the PL/pgSQL block structure and show you how to develop and execute anonymous blocks


### 变量与常量 Variables & constants

#### Variables - show you how to declare variables in PL/pgSQL

#### Select into - guide you on how to use the select  into to select data and assign it to a variable

#### Row type variables - learn how to use the row variables to store a complete row of a result set

#### Record type variables - show you how to declare record variables to hold a single row of a result set

#### Constants - guide you on how to use constants to make the code more readable and easier to maintain



### 报告消息与错误 Reporting messages and errors

#### Raising errors and reporting messages - show you how to report messages and raise errors in PL/pgSQL

#### Assert - show you how to use the assert statement to add debugging checks to PL/pgSQL code


### 流程控制 Control structures

#### If statement - introduce you to three forms of the if statements 

#### Case statements - explain case statements including the simple and searchd case statements

#### Loop statements - show you how to use loop statements to execute a block of code repeatedly based on a condition

#### While loop - learn how to use the while loop statement to create a pre-test loop

#### For loop - show you how to use the for loop statement to iterate over rows of a result set

#### Exit - guide you on how to use the exit statement to terminate a loop

#### Continue - provide you with a way to use the continue statement to skip the current loop iteration and start a new one


### 自定义函数 User-defined functions

#### Create Function - show you how to develop a user-defined function by using the create function statement

#### Function parameter modes - introduce you to various parameter modes including IN, OUT, and INOUT

#### Function overloading - introduce you to the function overloading

#### Functions that return a table - show you how to develop a function that returns a table

#### Drop function - learn how to remove an existing function


### 异常处理 Exception handling
- Handling exception - show you how to use the exception clause to catch and handle exceptions.

### 存储过程 Stored procedures

#### Create procedure - show you how to create and call a stored procedure

#### Drop procedure - learn how to drop a stored procedure


### 游标 Cursors
- Cursors - show you how to use cursors to process a result set, row by row

### 触发器 Trigger functions 
- Trigger procedures using PL/pgSQL - apply PL/pgSQL to define trigger procedures


## 数据库管理

### 视图 Views
A view is named query that provides another way to present data in the database tables. A view is defined based on one or more tables which are known as base tables. When you create a view, you basically create a query and assign it a name, therefore a view is useful for wrapping a commonly used complex query.

Note that regular views do not store any data except the materialized views. In postgreSQL, you can create special view called materialized views that store data physically and periodically refresh data from the base tables. The materialized views are very useful in many scenarios such as faster data access to a remote server and caching.

#### Managing PostgreSQL views - introduce you to the concept of the view and show you how to create, modify, and remove PostgreSQL views

#### Drop view - learn how to drop one or more views from the database

#### Create updatable views - give you examples of creating updatable views that allow you to issue INSERT, UPDATE, and DELETE statements to update data in the base table throught the views.

#### Materialized views - introduce you to materialized views and provide you with the steps of creting and refreshing data from materialized views

#### Creating updatable views using the WITH CHECK OPTION clause - show you how to use the WITH CHECK OPTION clause to check the view-defining condition when you make a change to the base table throught the view

#### Create recursive views - introduce you to the recursive view and show you an example of creating a recursive view in PostgreSQL


### 索引 Indexs

### 触发器 Triggers


### 管理 Administration

#### 管理数据库 Managing Databases

##### 创建数据库 Create Database

##### 修改数据库 Alter Database

##### 重命名数据库 Rename Database

##### 删除数据库 Drop Database

##### 复制数据库 Copy a Database

##### 查看数据库大小 Get Database Object Sizes


#### 管理表描述 Managing Schemas

##### 表描述 Schema

##### 创建表描述 Create Schema 

##### 修改表描述 Alter Schema

##### 删除表描述 Drop schema


#### 管理表空间 Managing Tablespaces

##### 创建表空间 Creating Tablespaces

##### 扩充表空间 Charging Tablespaces

##### 删除表空间 Delete Tablespaces


#### 角色与权限 Roles & Privileges

##### 创建角色 Create role

##### 授权 Grant

##### 吊销 Revoke

##### 修改角色 Alter role

##### 删除角色 Drop role

##### 角色关系 Role membership

##### 列出用户角色 List user roles


#### 备份与恢复 Backup & Restore Databases

##### 备份 Backup

##### 恢复 Restore


#### 提示与技巧 PostgreSQL Tips

##### 重设密码 Reset Password

##### 使用psql psql Commands

##### 获取表描述 Describe Table

##### 列数所有数据库 Show Databases

##### 列出所有表 Show Tables


## 函数库

### 集合函数 PostgreSQL Aggregate Functions

### 日期函数 PostgreSQL Date Functions

### 字符串函数 PostgresQL String Functions

### 数学函数 PostgreSQL Math Functions

### 窗口函数 PostgreSQL Window Functions
